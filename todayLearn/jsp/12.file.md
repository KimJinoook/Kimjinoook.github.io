# 파일 업로드
## 1. 폼 형태
- 웹 브라우저를 통해 파일을 전송하기 위한 폼 구성
  - input type = file
  - method = post
  - enctype = multipart/form-data
    - 파일 이름과 함께 데이터 전송
    - 기본값 application/x-www-form-urlencoded
      - 파일 이름만 전송
  - 업로드 컴포넌트 : cos.jar
- post로 전송된 파라미터는 request 객체를 통해 이름에 해당하는 값을 얻어낼 수 있다
  - multipart/form-data로 지정한 폼은 request 객체로 얻어낸 파라미터의 이름으로 값을 얻어낼 수 없다
  - 이름과 값을 가져오고, input type = file로 지정된 파일을 업로드 하기 위해서는 특별 컴포넌트가 필요
    - www.servlets.com에서 제공하는 cos.jar 파일에서 필요 컴포넌트를 선택하여 업로드 수행   

***

## 2. MultipartRequest 클래스
- 생성자   

```java
 MultipartRequest(javax.servlet.http.HttpServletRequest request, 
    java.lang.String saveDirectory, 
    int maxPostSize, 
    java.lang.String encoding, 
    FileRenamePolicy policy)
    
MultipartRequest mr = new MultipartRequest(request, //request 객체
    fileDirectory, // 파일이 저장될 경로
    1024*5, // 파일 최대 크기 (1024*5 = 5kb)
    “utf-8”, // 인코딩 타입
    new DefaultFileRenamePolicy()); //한글 인코딩이나 업로드 파일이 중복 시, 파일명 변경, 덮어쓰기 방지

```   

#### 메서드
![캡처](https://user-images.githubusercontent.com/99188096/167757940-bd704e4f-63f9-4a82-875d-629f3b067008.PNG)   
![캡처2](https://user-images.githubusercontent.com/99188096/167757945-4463ad1f-9f61-4c82-b021-a96693422e52.PNG)   


***

## 3. 예제
#### uploadTest1.jsp
```java
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<form name="frm1" method="post" action="upload_ok.jsp" enctype="multipart/form-data" >
		아이디 : <input type="text" name="id"><br>
		파일 업로드 : <input type="file" name="fileName" size="30"><br>
		<input type = "submit" value="등록"><br>
	</form>
</body>
</html>
```

#### upload_ok.jsp
```
<%@page import="java.io.File"%>
<%@page import="com.oreilly.servlet.multipart.DefaultFileRenamePolicy"%>
<%@page import="com.oreilly.servlet.MultipartRequest"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<%
		//MultipartRequest 객체 생성 성공 -> 업로드 완료
		//실패 -> IOException 발생(용량 초과 등)
		
		String upDir="pos_upload";//업로드할 폴더
		
		String saveDir=application.getRealPath(upDir); //업로드할 폴더 절대경로 구하기
		System.out.println("saveDir = "+saveDir);
		
		saveDir = config.getServletContext().getRealPath(upDir);
		System.out.println("saveDir = "+saveDir);
		
		saveDir = "C:\\lecture\\workspace.list\\jsp_ws\\herbmall\\src\\main\\webapp\\pds_upload";
		
		int maxSize = 2*1024*1024; // 업로드 최대 용량, 2M
		
		String encoding="utf-8"; // 인코딩 형식
		
		//업로드 시 동일한 파일명이 있을 경우 나중에 업로드한 파일에 번호를 붙여 이름 변경
		DefaultFileRenamePolicy policy = new DefaultFileRenamePolicy();
		
		MultipartRequest mr = new MultipartRequest(request, saveDir, maxSize, encoding, policy);
		
		out.print("업로드 완료");
		
		//업로드된 파일 정보 얻어오기
		String fileName = mr.getFilesystemName("fileName"); //변경된 파일명
		String originFileName = mr.getOriginalFileName("fileName"); //원본 파일명
		
		File file = mr.getFile("fileName");
		long fileSize = file.length();
		String id = request.getParameter("id");
		String id2 = mr.getParameter("id");
		
	%>
	<h1> 업로드된 파일 정보</h1>
	<p> 변경 후 파일 명 : <%=fileName %></p>
	<p> 변경 전 파일 명 : <%=originFileName %></p>
	<p> 파일 크기 : <%=fileSize %></p>
	
	<h1> 파라미터</h1>
	<p>id (request) : <%=id %></p>
	<p>id2(mr) : <%=id2 %></p>
</body>
</html>
```

***

## 4. 예제2 다중 업로드
#### uploadTest2.java   
```java
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<h1>파일 업로드 테스트2</h1>
	<form name="frm1" method="post" action="uploadTest2_ok.jsp" 
		encType="multipart/form-data">
		
		아이디 <input type="text" name="id"/><br>
		주소 <input type="text" name="address"/><br>
		파일첨부<br> 
		<input type="file" name="upfile1" /><br>
		<input type="file" name="upfile2" /><br>
		<input type="file" name="upfile3" /><br><br>
		<input type="submit" value="전송" />
	</form>
</body>
</html>
```

#### uploadTest2_ok.jsp
```java
<%@page import="java.io.IOException"%>
<%@page import="java.util.Enumeration"%>
<%@page import="java.io.File"%>
<%@page import="com.oreilly.servlet.multipart.DefaultFileRenamePolicy"%>
<%@page import="com.oreilly.servlet.MultipartRequest"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<%
		//MultipartRequest 객체 생성 성공 -> 업로드 완료
		//실패 -> IOException 발생(용량 초과 등)
		
		String upDir="pos_upload";//업로드할 폴더
		
		String saveDir=application.getRealPath(upDir); //업로드할 폴더 절대경로 구하기
		System.out.println("saveDir = "+saveDir);
		
		saveDir = config.getServletContext().getRealPath(upDir);
		System.out.println("saveDir = "+saveDir);
		
		saveDir = "C:\\lecture\\workspace.list\\jsp_ws\\herbmall\\src\\main\\webapp\\pds_upload";
		
		int maxSize = 2*1024*1024; // 업로드 최대 용량, 2M
		
		String encoding="utf-8"; // 인코딩 형식
		
		//업로드 시 동일한 파일명이 있을 경우 나중에 업로드한 파일에 번호를 붙여 이름 변경
		DefaultFileRenamePolicy policy = new DefaultFileRenamePolicy();
		
		try{
			
			MultipartRequest mr = new MultipartRequest(request, saveDir, maxSize, encoding, policy);
			
			out.print("업로드 완료");
			
			Enumeration enFileNames = mr.getFileNames(); // 여러 파일의 이름 목록 리턴
			
			while(enFileNames.hasMoreElements()){
				String fName=(String)enFileNames.nextElement();
				
				String fileName = mr.getFilesystemName(fName); //변경된 파일 이름
				
				String originFileName=mr.getOriginalFileName(fName); //변경전 파일 이름
				
				File f = mr.getFile(fName);
				long fileSize = 0;
				if(f != null){
					fileSize = f.length();
				}
				
				out.print("업로드된 파일명 : "+fileName+"<br>");
				out.print("원래 파일명 : "+originFileName+"<br>");
				out.print("파일크기 : "+fileSize+"<br>");
				
				
			}
			
			String id = mr.getParameter("id");
			String addr=mr.getParameter("address");
			out.print("<h1> 파라미터 <h1>");
			out.print("id : "+id+"<br>");
			out.print("address : "+addr+"<br>");
			
		}catch(IOException e){
			out.print("2M 이상의 파일은 업로드할 수 없습니다.");
			e.printStackTrace();
		}
	%>
</body>
</html>
```
